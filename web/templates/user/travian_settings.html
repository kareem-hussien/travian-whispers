{% extends 'user/layout.html' %}

{% block title %}Travian Settings{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">Travian Settings</li>
{% endblock %}

{% block content %}
<div class="content">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-4">Travian Settings</h2>
            
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>
    </div>
    
    <div class="row">
        <!-- Travian Account Information -->
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card">
                <h4 class="mb-4">Travian Account Information</h4>
                
                <form action="{{ url_for('travian_settings') }}" method="post">
                    <div class="mb-3">
                        <label for="travian_username" class="form-label">Travian Username</label>
                        <input type="text" class="form-control" id="travian_username" name="travian_username" value="{{ user_profile.travian_credentials.username }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="travian_password" class="form-label">Travian Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="travian_password" name="travian_password" value="********" required>
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">Your password is encrypted before storage</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="travian_server" class="form-label">Travian Server</label>
                        <input type="text" class="form-control" id="travian_server" name="travian_server" value="{{ user_profile.travian_credentials.server }}" required>
                        <small class="form-text text-muted">Example: ts1.x1.international.travian.com</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="travian_tribe" class="form-label">Travian Tribe</label>
                        <select class="form-select" id="travian_tribe" name="travian_tribe" required>
                            <option value="Romans" {% if user_profile.travian_credentials.tribe == 'Romans' %}selected{% endif %}>Romans</option>
                            <option value="Teutons" {% if user_profile.travian_credentials.tribe == 'Teutons' %}selected{% endif %}>Teutons</option>
                            <option value="Gauls" {% if user_profile.travian_credentials.tribe == 'Gauls' %}selected{% endif %}>Gauls</option>
                            <option value="Egyptians" {% if user_profile.travian_credentials.tribe == 'Egyptians' %}selected{% endif %}>Egyptians</option>
                            <option value="Huns" {% if user_profile.travian_credentials.tribe == 'Huns' %}selected{% endif %}>Huns</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Account Settings</button>
                    <button type="button" class="btn btn-info" id="testConnectionBtn">Test Connection</button>
                </form>
            </div>
        </div>
        
        <!-- Connection Status & Instructions -->
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card">
                <h4 class="mb-4">Connection Status</h4>
                
                <div class="alert alert-success mb-4" id="connectionStatus">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    Last successful connection: <span id="lastConnection">2025-03-12 15:30:45</span>
                </div>
                
                <h5 class="mb-3">How to Find Your Server</h5>
                <p>The server address can be found in the URL of your Travian game. For example, if your game URL is <code>https://ts1.x1.international.travian.com/...</code>, your server address is <code>ts1.x1.international.travian.com</code>.</p>
                
                <h5 class="mb-3 mt-4">Tribe Selection</h5>
                <p>Select your tribe from the dropdown menu. This helps the bot optimize troop training based on your tribe's specific units.</p>
                
                <div class="alert alert-info mt-4">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    <strong>Tip:</strong> Make sure to use the same username and password you use to log into Travian. These credentials are securely encrypted in our database.
                </div>
            </div>
        </div>
        
        <!-- Bot Settings -->
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card">
                <h4 class="mb-4">Bot Behavior Settings</h4>
                
                <form action="{{ url_for('travian_settings') }}" method="post">
                    <input type="hidden" name="form_type" value="bot_settings">
                    
                    <div class="mb-3">
                        <label for="randomization" class="form-label">Action Randomization</label>
                        <select class="form-select" id="randomization" name="randomization">
                            <option value="low" {% if user_profile.settings.randomization == 'low' %}selected{% endif %}>Low (Faster, less human-like)</option>
                            <option value="medium" {% if user_profile.settings.randomization == 'medium' or not user_profile.settings.randomization %}selected{% endif %}>Medium (Balanced)</option>
                            <option value="high" {% if user_profile.settings.randomization == 'high' %}selected{% endif %}>High (Slower, more human-like)</option>
                        </select>
                        <small class="form-text text-muted">Controls how random the bot's timing appears</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="farming_interval" class="form-label">Farming Interval (minutes)</label>
                        <input type="number" class="form-control" id="farming_interval" name="farming_interval" 
                               value="{{ user_profile.settings.farming_interval|default(30) }}" min="15" max="120" required>
                        <small class="form-text text-muted">Time between farm list activations</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="training_interval" class="form-label">Training Interval (minutes)</label>
                        <input type="number" class="form-control" id="training_interval" name="training_interval" 
                               value="{{ user_profile.settings.training_interval|default(60) }}" min="30" max="240" required>
                        <small class="form-text text-muted">Time between troop training checks</small>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="captcha_notification" name="captcha_notification" 
                               {% if user_profile.settings.captcha_notification|default(true) %}checked{% endif %}>
                        <label class="form-check-label" for="captcha_notification">Notify me when CAPTCHA appears</label>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="auto_restart" name="auto_restart" 
                               {% if user_profile.settings.auto_restart|default(true) %}checked{% endif %}>
                        <label class="form-check-label" for="auto_restart">Auto-restart bot after errors</label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Bot Settings</button>
                </form>
            </div>
        </div>
        
        <!-- Browser Settings -->
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card">
                <h4 class="mb-4">Browser Settings</h4>
                
                <form action="{{ url_for('travian_settings') }}" method="post">
                    <input type="hidden" name="form_type" value="browser_settings">
                    
                    <div class="mb-3">
                        <label for="browser_type" class="form-label">Browser Type</label>
                        <select class="form-select" id="browser_type" name="browser_type">
                            <option value="chrome" {% if user_profile.settings.browser_type == 'chrome' or not user_profile.settings.browser_type %}selected{% endif %}>Chrome</option>
                            <option value="firefox" {% if user_profile.settings.browser_type == 'firefox' %}selected{% endif %}>Firefox</option>
                        </select>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="headless" name="headless" 
                               {% if user_profile.settings.headless %}checked{% endif %}>
                        <label class="form-check-label" for="headless">Run in headless mode</label>
                        <small class="form-text text-muted d-block">Headless mode runs without visible browser window (more efficient)</small>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="save_session" name="save_session" 
                               {% if user_profile.settings.save_session|default(true) %}checked{% endif %}>
                        <label class="form-check-label" for="save_session">Save browser session</label>
                        <small class="form-text text-muted d-block">Allows the bot to resume without logging in each time</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="user_agent" class="form-label">Custom User Agent (Optional)</label>
                        <input type="text" class="form-control" id="user_agent" name="user_agent" 
                               value="{{ user_profile.settings.user_agent|default('') }}" placeholder="Leave blank for default">
                        <small class="form-text text-muted">Custom browser fingerprint (advanced)</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Browser Settings</button>
                    <button type="button" class="btn btn-danger" id="clearSessionBtn">Clear Saved Session</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toggle password visibility
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('travian_password');
        const icon = this.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    });
    
    // Test connection button
    document.getElementById('testConnectionBtn').addEventListener('click', function() {
        // Show loading state
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';
        
        const connectionStatus = document.getElementById('connectionStatus');
        const lastConnection = document.getElementById('lastConnection');
        
        // Simulate connection test (in production, this would make an AJAX call)
        setTimeout(() => {
            const success = Math.random() > 0.3; // 70% success rate for demo
            
            if (success) {
                connectionStatus.className = 'alert alert-success mb-4';
                connectionStatus.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Connection successful!';
                const now = new Date();
                lastConnection.textContent = now.toLocaleString();
            } else {
                connectionStatus.className = 'alert alert-danger mb-4';
                connectionStatus.innerHTML = '<i class="bi bi-x-circle-fill me-2"></i>Connection failed. Please check your credentials.';
            }
            
            // Reset button
            this.disabled = false;
            this.innerHTML = 'Test Connection';
        }, 2000);
    });
    
    // Clear session button
    document.getElementById('clearSessionBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear your saved browser session? You will need to log in again next time.')) {
            // Show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Clearing...';
            
            // Simulate clearing session (in production, this would make an AJAX call)
            setTimeout(() => {
                alert('Browser session cleared successfully.');
                
                // Reset button
                this.disabled = false;
                this.innerHTML = 'Clear Saved Session';
            }, 1000);
        }
    });
</script>
{% endblock %}