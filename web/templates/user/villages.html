{% extends 'user/layout.html' %}

{% block title %}Villages Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">Villages</li>
{% endblock %}

{% block content %}
<div class="content">
    <!-- Page Header -->
    {% with 
        title="Villages Management",
        subtitle="Manage your Travian villages for automation",
        show_buttons=True,
        primary_button_text="Extract Villages",
        primary_button_icon="arrow-repeat",
        primary_button_id="extractVillages"
    %}
        {% include 'user/components/page_header.html' %}
    {% endwith %}
    
    <!-- Villages List Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <h4 class="mb-3">Your Villages</h4>
                
                {% if villages and villages|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Village Name</th>
                                    <th>Coordinates</th>
                                    <th>Population</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for village in villages %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ url_for('static', filename='img/icon/village-icon.png') }}" 
                                                 alt="Village" width="24" height="24" class="me-2">
                                            <span>{{ village.name }}</span>
                                        </div>
                                    </td>
                                    <td>({{ village.x }}|{{ village.y }})</td>
                                    <td>{{ village.population|default('Unknown') }}</td>
                                    <td>
                                        <span class="badge {% if village.status == 'active' %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ village.status|default('active')|capitalize }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-primary village-details" 
                                                    data-village-id="{{ village.newdid }}" data-bs-toggle="modal" 
                                                    data-bs-target="#villageDetailsModal">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-warning village-edit" 
                                                    data-village-id="{{ village.newdid }}" data-bs-toggle="modal" 
                                                    data-bs-target="#editVillageModal">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger village-remove" 
                                                    data-village-id="{{ village.newdid }}" data-village-name="{{ village.name }}">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        No villages found. Click the "Extract Villages" button to fetch your villages from Travian.
                    </div>
                {% endif %}
                
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addVillageModal">
                        <i class="bi bi-plus-circle me-2"></i>Add Village Manually
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Villages Stats Section -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="dashboard-card">
                <h4 class="mb-3">Villages Statistics</h4>
                
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="stat-card">
                            <div class="stat-title">Total Villages</div>
                            <div class="stat-value">{{ villages|length }}</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-card">
                            <div class="stat-title">Active Villages</div>
                            <div class="stat-value">{{ villages|selectattr('status', 'equalto', 'active')|list|length }}</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-card">
                            <div class="stat-title">Total Population</div>
                            <div class="stat-value">
                                {% set total_pop = 0 %}
                                {% for village in villages %}
                                    {% set total_pop = total_pop + (village.population|default(0)|int) %}
                                {% endfor %}
                                {{ total_pop }}
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-card">
                            <div class="stat-title">Automation Status</div>
                            <div class="stat-value">
                                {% if current_user.settings.autoFarm %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="dashboard-card">
                <h4 class="mb-3">Automation Settings</h4>
                
                <div class="alert alert-primary mb-3">
                    <i class="bi bi-lightbulb-fill me-2"></i>
                    Configure which villages should be used for auto-farming and troop training.
                </div>
                
                <form id="villageSettingsForm">
                    <div class="mb-3">
                        <label class="form-label">Auto-Farm Villages</label>
                        <select class="form-select" id="autoFarmVillages" multiple>
                            {% for village in villages %}
                                <option value="{{ village.newdid }}" {% if village.auto_farm_enabled %}selected{% endif %}>
                                    {{ village.name }} ({{ village.x }}|{{ village.y }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Troop Training Villages</label>
                        <select class="form-select" id="trainingVillages" multiple>
                            {% for village in villages %}
                                <option value="{{ village.newdid }}" {% if village.training_enabled %}selected{% endif %}>
                                    {{ village.name }} ({{ village.x }}|{{ village.y }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Village Details Modal -->
<div class="modal fade" id="villageDetailsModal" tabindex="-1" aria-labelledby="villageDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="villageDetailsModalLabel">Village Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Basic Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <strong>Name:</strong> <span id="detailsVillageName"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>Coordinates:</strong> <span id="detailsVillageCoords"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>Population:</strong> <span id="detailsVillagePopulation"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>Village ID:</strong> <span id="detailsVillageId"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Resources</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <i class="bi bi-tree text-success me-2"></i> <strong>Wood:</strong> 
                                    <span id="detailsResourceWood">0</span>
                                </div>
                                <div class="mb-2">
                                    <i class="bi bi-circle-fill text-warning me-2"></i> <strong>Clay:</strong> 
                                    <span id="detailsResourceClay">0</span>
                                </div>
                                <div class="mb-2">
                                    <i class="bi bi-circle-half text-secondary me-2"></i> <strong>Iron:</strong> 
                                    <span id="detailsResourceIron">0</span>
                                </div>
                                <div class="mb-2">
                                    <i class="bi bi-flower1 text-primary me-2"></i> <strong>Crop:</strong> 
                                    <span id="detailsResourceCrop">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Automation Status</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-center">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="detailsAutoFarm" disabled>
                                                <label class="form-check-label" for="detailsAutoFarm">Auto-Farm Enabled</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-center">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="detailsTraining" disabled>
                                                <label class="form-check-label" for="detailsTraining">Troop Training Enabled</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <strong>Last Farm:</strong> <span id="detailsLastFarm">Never</span>
                                </div>
                                <div class="mt-2">
                                    <strong>Last Training:</strong> <span id="detailsLastTraining">Never</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="openVillageInTravian">Open in Travian</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Village Modal -->
<div class="modal fade" id="editVillageModal" tabindex="-1" aria-labelledby="editVillageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editVillageModalLabel">Edit Village</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editVillageForm">
                    <input type="hidden" id="editVillageId" name="village_id">
                    
                    <div class="mb-3">
                        <label for="editVillageName" class="form-label">Village Name</label>
                        <input type="text" class="form-control" id="editVillageName" name="village_name" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="editVillageX" class="form-label">X Coordinate</label>
                            <input type="number" class="form-control" id="editVillageX" name="village_x" required>
                        </div>
                        <div class="col-6">
                            <label for="editVillageY" class="form-label">Y Coordinate</label>
                            <input type="number" class="form-control" id="editVillageY" name="village_y" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editVillagePopulation" class="form-label">Population</label>
                        <input type="number" class="form-control" id="editVillagePopulation" name="village_population">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Automation Settings</label>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="editAutoFarm" name="auto_farm">
                            <label class="form-check-label" for="editAutoFarm">Enable Auto-Farm for this village</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editTraining" name="training">
                            <label class="form-check-label" for="editTraining">Enable Troop Training for this village</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveVillageBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Village Modal -->
<div class="modal fade" id="addVillageModal" tabindex="-1" aria-labelledby="addVillageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVillageModalLabel">Add Village Manually</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addVillageForm">
                    <div class="mb-3">
                        <label for="addVillageName" class="form-label">Village Name</label>
                        <input type="text" class="form-control" id="addVillageName" name="village_name" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="addVillageX" class="form-label">X Coordinate</label>
                            <input type="number" class="form-control" id="addVillageX" name="village_x" required>
                        </div>
                        <div class="col-6">
                            <label for="addVillageY" class="form-label">Y Coordinate</label>
                            <input type="number" class="form-control" id="addVillageY" name="village_y" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="addVillageNewdid" class="form-label">Village ID (newdid)</label>
                        <input type="text" class="form-control" id="addVillageNewdid" name="village_newdid" required>
                        <small class="form-text text-muted">You can find this in the URL when viewing the village in Travian</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="addVillagePopulation" class="form-label">Population (optional)</label>
                        <input type="number" class="form-control" id="addVillagePopulation" name="village_population">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Automation Settings</label>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="addAutoFarm" name="auto_farm">
                            <label class="form-check-label" for="addAutoFarm">Enable Auto-Farm for this village</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="addTraining" name="training">
                            <label class="form-check-label" for="addTraining">Enable Troop Training for this village</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addVillageBtn">Add Village</button>
            </div>
        </div>
    </div>
</div>

<!-- Extract Villages Modal -->
<div class="modal fade" id="extractVillagesModal" tabindex="-1" aria-labelledby="extractVillagesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="extractVillagesModalLabel">Extract Villages from Travian</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    This will log into your Travian account and extract all your villages. Make sure your Travian credentials are correctly set in your <a href="{{ url_for('user.travian_settings') }}">Travian Settings</a>.
                </div>
                
                <div id="extractProgress" class="d-none">
                    <div class="text-center mb-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="extractStatus" class="text-center mb-3">Preparing to extract villages...</div>
                </div>
                
                <div id="extractResults" class="d-none">
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <span id="extractSuccessMessage">Villages extracted successfully!</span>
                    </div>
                    
                    <h6>Extracted Villages:</h6>
                    <ul id="extractedVillagesList" class="list-group mb-3"></ul>
                </div>
                
                <div id="extractError" class="d-none">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="extractErrorMessage">An error occurred.</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="extractCancelBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmExtractBtn">Start Extraction</button>
                <button type="button" class="btn btn-success d-none" data-bs-dismiss="modal" id="extractDoneBtn">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Village Confirmation Modal -->
<div class="modal fade" id="removeVillageModal" tabindex="-1" aria-labelledby="removeVillageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeVillageModalLabel">Confirm Removal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove the village "<span id="removeVillageName"></span>"?</p>
                <p class="text-muted">This will only remove the village from Travian Whispers. Your actual village in Travian will not be affected.</p>
                <input type="hidden" id="removeVillageId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRemoveBtn">Remove Village</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize page elements
    document.addEventListener('DOMContentLoaded', function() {
        // Extract Villages button
        document.getElementById('extractVillages').addEventListener('click', function() {
            $('#extractVillagesModal').modal('show');
        });
        
        // Village extraction process
        document.getElementById('confirmExtractBtn').addEventListener('click', function() {
            startVillageExtraction();
        });
        
        // Village details button events
        document.querySelectorAll('.village-details').forEach(button => {
            button.addEventListener('click', function() {
                const villageId = this.getAttribute('data-village-id');
                showVillageDetails(villageId);
            });
        });
        
        // Village edit button events
        document.querySelectorAll('.village-edit').forEach(button => {
            button.addEventListener('click', function() {
                const villageId = this.getAttribute('data-village-id');
                populateEditVillageForm(villageId);
            });
        });
        
        // Village remove button events
        document.querySelectorAll('.village-remove').forEach(button => {
            button.addEventListener('click', function() {
                const villageId = this.getAttribute('data-village-id');
                const villageName = this.getAttribute('data-village-name');
                showRemoveVillageConfirmation(villageId, villageName);
            });
        });
        
        // Save village edit
        document.getElementById('saveVillageBtn').addEventListener('click', function() {
            saveVillageChanges();
        });
        
        // Add village button
        document.getElementById('addVillageBtn').addEventListener('click', function() {
            addVillage();
        });
        
        // Confirm remove village button
        document.getElementById('confirmRemoveBtn').addEventListener('click', function() {
            removeVillage();
        });
        
        // Village settings form submit
        document.getElementById('villageSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveVillageSettings();
        });
        
        // Open village in Travian button
        document.getElementById('openVillageInTravian').addEventListener('click', function() {
            const villageId = document.querySelector('#villageDetailsModal').getAttribute('data-village-id');
            if (villageId) {
                // Construct Travian URL
                const travianUrl = "https://ts1.x1.international.travian.com/dorf1.php?newdid=" + villageId;
                window.open(travianUrl, '_blank');
            }
        });
    });
    
    // Show village details in modal
    function showVillageDetails(villageId) {
        // Find the village data from the list of villages
        {% if villages and villages|length > 0 %}
        const villages = {{ villages|tojson }};
        const village = villages.find(v => v.newdid === villageId);
        
        if (village) {
            // Set modal data attribute for village ID
            document.querySelector('#villageDetailsModal').setAttribute('data-village-id', villageId);
            
            // Update modal with village data
            document.getElementById('detailsVillageName').textContent = village.name;
            document.getElementById('detailsVillageCoords').textContent = `(${village.x}|${village.y})`;
            document.getElementById('detailsVillagePopulation').textContent = village.population || 'Unknown';
            document.getElementById('detailsVillageId').textContent = village.newdid;
            
            // Update resources if available
            if (village.resources) {
                document.getElementById('detailsResourceWood').textContent = village.resources.wood || '0';
                document.getElementById('detailsResourceClay').textContent = village.resources.clay || '0';
                document.getElementById('detailsResourceIron').textContent = village.resources.iron || '0';
                document.getElementById('detailsResourceCrop').textContent = village.resources.crop || '0';
            }
            
            // Update automation settings
            document.getElementById('detailsAutoFarm').checked = village.auto_farm_enabled || false;
            document.getElementById('detailsTraining').checked = village.training_enabled || false;
            
            // Update activity info if available
            document.getElementById('detailsLastFarm').textContent = village.last_farmed || 'Never';
            document.getElementById('detailsLastTraining').textContent = village.last_trained || 'Never';
        }
        {% endif %}
    }
    
    // Populate edit village form
    function populateEditVillageForm(villageId) {
        {% if villages and villages|length > 0 %}
        const villages = {{ villages|tojson }};
        const village = villages.find(v => v.newdid === villageId);
        
        if (village) {
            // Set form field values
            document.getElementById('editVillageId').value = village.newdid;
            document.getElementById('editVillageName').value = village.name;
            document.getElementById('editVillageX').value = village.x;
            document.getElementById('editVillageY').value = village.y;
            document.getElementById('editVillagePopulation').value = village.population || '';
            document.getElementById('editAutoFarm').checked = village.auto_farm_enabled || false;
            document.getElementById('editTraining').checked = village.training_enabled || false;
        }
        {% endif %}
    }
    
    // Show remove village confirmation
    function showRemoveVillageConfirmation(villageId, villageName) {
        document.getElementById('removeVillageId').value = villageId;
        document.getElementById('removeVillageName').textContent = villageName;
        $('#removeVillageModal').modal('show');
    }
    
    // Save village changes
    function saveVillageChanges() {
        const villageId = document.getElementById('editVillageId').value;
        const villageName = document.getElementById('editVillageName').value;
        const villageX = document.getElementById('editVillageX').value;
        const villageY = document.getElementById('editVillageY').value;
        const villagePopulation = document.getElementById('editVillagePopulation').value;
        const autoFarmEnabled = document.getElementById('editAutoFarm').checked;
        const trainingEnabled = document.getElementById('editTraining').checked;
        
        // Send AJAX request to update village
        fetch('/api/user/villages/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                village_id: villageId,
                village_name: villageName,
                village_x: parseInt(villageX),
                village_y: parseInt(villageY),
                village_population: parseInt(villagePopulation) || 0,
                auto_farm_enabled: autoFarmEnabled,
                training_enabled: trainingEnabled
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                $('#editVillageModal').modal('hide');
                
                // Show success message
                alert('Village updated successfully!');
                
                // Reload the page to show updated data
                location.reload();
            } else {
                // Show error message
                alert('Error updating village: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the village');
        });
    }
    
    // Add new village
    function addVillage() {
        const villageName = document.getElementById('addVillageName').value;
        const villageX = document.getElementById('addVillageX').value;
        const villageY = document.getElementById('addVillageY').value;
        const villageNewdid = document.getElementById('addVillageNewdid').value;
        const villagePopulation = document.getElementById('addVillagePopulation').value;
        const autoFarmEnabled = document.getElementById('addAutoFarm').checked;
        const trainingEnabled = document.getElementById('addTraining').checked;
        
        // Validate inputs
        if (!villageName || !villageX || !villageY || !villageNewdid) {
            alert('Please fill in all required fields');
            return;
        }
        
        // Send AJAX request to add village
        fetch('/api/user/villages/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                village_name: villageName,
                village_x: parseInt(villageX),
                village_y: parseInt(villageY),
                village_newdid: villageNewdid,
                village_population: parseInt(villagePopulation) || 0,
                auto_farm_enabled: autoFarmEnabled,
                training_enabled: trainingEnabled
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                $('#addVillageModal').modal('hide');
                
                // Show success message
                alert('Village added successfully!');
                
                // Reload the page to show updated data
                location.reload();
            } else {
                // Show error message
                alert('Error adding village: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the village');
        });
    }
    
    // Remove village
    function removeVillage() {
        const villageId = document.getElementById('removeVillageId').value;
        
        // Send AJAX request to remove village
        fetch('/api/user/villages/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                village_id: villageId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                $('#removeVillageModal').modal('hide');
                
                // Show success message
                alert('Village removed successfully!');
                
                // Reload the page to show updated data
                location.reload();
            } else {
                // Show error message
                alert('Error removing village: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while removing the village');
        });
    }
    
    // Save village settings
    function saveVillageSettings() {
        // Get selected villages for auto farm
        const autoFarmVillages = Array.from(document.getElementById('autoFarmVillages').selectedOptions).map(option => option.value);
        
        // Get selected villages for troop training
        const trainingVillages = Array.from(document.getElementById('trainingVillages').selectedOptions).map(option => option.value);
        
        // Send AJAX request to save settings
        fetch('/api/user/villages/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                auto_farm_villages: autoFarmVillages,
                training_villages: trainingVillages
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                alert('Village settings saved successfully!');
            } else {
                // Show error message
                alert('Error saving village settings: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving village settings');
        });
    }
    
    // Start village extraction process
    function startVillageExtraction() {
        // Show progress section and hide others
        document.getElementById('extractProgress').classList.remove('d-none');
        document.getElementById('extractResults').classList.add('d-none');
        document.getElementById('extractError').classList.add('d-none');
        
        // Hide/show buttons
        document.getElementById('confirmExtractBtn').classList.add('d-none');
        document.getElementById('extractCancelBtn').classList.add('d-none');
        document.getElementById('extractDoneBtn').classList.add('d-none');
        
        // Update progress bar and status
        const progressBar = document.querySelector('#extractProgress .progress-bar');
        const statusText = document.getElementById('extractStatus');
        progressBar.style.width = '10%';
        statusText.textContent = 'Checking Travian credentials...';
        
        // Simulate progress updates (in a real implementation, this would be based on actual backend progress)
        setTimeout(() => {
            progressBar.style.width = '30%';
            statusText.textContent = 'Logging into Travian...';
            
            setTimeout(() => {
                progressBar.style.width = '60%';
                statusText.textContent = 'Extracting village data...';
                
                // Send AJAX request to extract villages
                fetch('/api/user/villages/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    progressBar.style.width = '100%';
                    
                    if (data.success) {
                        // Show success results
                        document.getElementById('extractProgress').classList.add('d-none');
                        document.getElementById('extractResults').classList.remove('d-none');
                        
                        // Update success message
                        document.getElementById('extractSuccessMessage').textContent = 
                            `Successfully extracted ${data.data.length} villages.`;
                        
                        // Populate villages list
                        const villagesList = document.getElementById('extractedVillagesList');
                        villagesList.innerHTML = '';
                        
                        data.data.forEach(village => {
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item';
                            listItem.textContent = `${village.name} (${village.x}|${village.y})`;
                            villagesList.appendChild(listItem);
                        });
                        
                        // Show Done button
                        document.getElementById('extractDoneBtn').classList.remove('d-none');
                    } else {
                        // Show error
                        showExtractionError(data.message || 'Failed to extract villages');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showExtractionError('An error occurred while extracting villages');
                });
            }, 1500);
        }, 1000);
    }
    
    // Show extraction error
    function showExtractionError(message) {
        document.getElementById('extractProgress').classList.add('d-none');
        document.getElementById('extractError').classList.remove('d-none');
        document.getElementById('extractErrorMessage').textContent = message;
        document.getElementById('extractCancelBtn').classList.remove('d-none');
    }
</script>
{% endblock %}